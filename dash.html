<!doctype html>
<html>
    <body ondblclick="switchFullScreen()">
        <div id="rpm-bar" class="seg-bar seg-bar-white valign">
            <span id="rpm">0</span>
            <small>rpm</small>
            <span class="seg-fill"></span>
        </div>

        <div class="valign halign">
            <h1 id="vss1">0</h1>
            <span id="units-vss1">mph</span><br />
            <div>Odometer: <span id="odometer"></span></div>
            <h3>Gear: <span id="gear">1</span></h3>
            <div>Fuel: <span id="fuel">&nbsp;</span></div>
            <div>Oil Pressure: <span id="oil_pressure">&nbsp;</span></div>
            <div>Coolant: <span id="clt">&nbsp;</span></div>
            <div>MAP: <span id="map">&nbsp;</span></div>
            <div><label id="launch" data-value="false">Launch</label></div>
            <div><label id="pit-lane-limitter" data-value="false">Pit</label></div>
        </div>

        <style>
            body {
                background: black;
                color: #cc5500;
            }

            #vss1 {
                font-size: 30vh;
                margin: -4vh;
            }

            #units-vss1 {
                font-size: 6vh;
            }

            #rpm {
                width: 12vh;
            }
            .valign {
                text-align: center;
            }
            .halign {
                margin: 0;
                position: absolute;
                top: 50%;
                left: 50%;
                margin-right: -50%;
                transform: translate(-50%, -50%)
            }
            
            .seg-bar-white {
                border: 1px solid white;
            }
            .seg-bar-white > .seg-fill {
                background: white;
            }

            .seg-bar-yellow {
                border: 1px solid yellow;
            }
            .seg-bar-yellow > .seg-fill {
                background: yellow;
            }

            .seg-bar-red {
                border: 1px solid red;
            }
            .seg-bar-red > .seg-fill {
                background: red;
            }

            .seg-bar {
                height:6vh;
                position:relative;
                width: 100%;
                color: green;
                font-size: 4.5vh;
            }

            .seg-fill {
                content:'\A';
                position:absolute;
                top:0; bottom:0;
                left:0; 
                width: 0%;
                z-index: -9999;
            }

            .blinking{
                animation:blinker .5s step-start infinite;
            }

            @keyframes blinker {
                50% {
                    opacity: .5;
                }
            }

            label {
                padding: 4px;
                color: white;
                border: 1px solid black;
            }

            #launch[data-value="false"] {
                background-color: red;
            }

            #launch[data-value="true"] {
                background-color: green;
            }

            #pit-lane-limitter[data-value="false"] {
                background-color: grey;
            }

            #pit-lane-limitter[data-value="true"] {
                background-color: green;
                animation: blinker .5s step-start infinite;
            }

        </style>
        <script type="text/javascript">
            var ranges;
            var proxies;

            function update_field(key, value) {
                var field = document.getElementById(key);
                if(field !== null) {
                    if(field.nodeName == "LABEL") {
                        field.setAttribute("data-value", value);
                    } else {
                        field.innerHTML = value;
                    }
                } 
            }

            function update_seg_bar(key, value) {
                var bar = document.getElementById(key + "-bar");
                 // TODO: just look for .seg-fill instead of grabbing last element
                var has_bar = bar !== null && bar.children.length > 0;
                let has_range = ranges[key] !== undefined;
                if(has_bar && has_range) {
                    bar.children[bar.children.length - 1].style.width = (value / ranges[key].max) * 100 + "%";
                    if(ranges[key] !== null) {
                        var this_range = ranges[key];
                        if(value >= this_range["danger"]) {
                            if(bar.className.indexOf("seg-bar-red") == -1) {
                                bar.className = bar.className.replace(" seg-bar-yellow", "");
                                bar.className += " seg-bar-red blinking";
                            }
                        } else if(value >= this_range["warning"]) {
                            if(bar.className.indexOf("seg-bar-yellow") == -1) {
                                bar.className = bar.className.replace(" seg-bar-red blinking", "");
                                bar.className += " seg-bar-yellow";
                            }
                        } else {
                            bar.className = bar.className.replace(" seg-bar-red blinking", "").replace(" seg-bar-yellow", "");
                        }
                    }
                }
            }

            function update(data) {
                Object.keys(data).forEach(key => {
                    var name = key;
                    if(proxies[key] != undefined) {
                        name = proxies[key]
                    }

                    update_field(name, data[key]);
                    update_seg_bar(name, data[key])
                });
            };

            function set_units(units) {
                Object.keys(units).forEach(key => {
                    var field = document.getElementById("units-" + key);
                    if(field !== null) {
                        field.innerHTML = units[key];
                    }
                }); 
            }

            function user_configuration(config) {
                ranges = config.ranges;
                proxies = config.proxies;
                set_units(config.units);

                if(ranges == undefined) {
                    ranges = {};
                }
                if(proxies == undefined) {
                    proxies = {};
                }
            };

            var fullscreen = true;
            function switchFullScreen() {
                if(fullscreen) {
                    external.invoke('exit');
                } else {
                    external.invoke('enter');
                }
                fullscreen = !fullscreen;
            }
        </script>
    </body>
</html>