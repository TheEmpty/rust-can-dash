<!doctype html>
<html>
    <body ondblclick="switchFullScreen()">
        <div id="rpm-bar" class="seg-bar seg-bar-white valign">
            <span id="rpm">0</span>
            <small>rpm</small>
            <span class="seg-fill"></span>
        </div>

        <div class="valign halign">
            <h1><span id="vss">0</span> <span id="units-vss">mph</span></h1>
            <h3>Gear: <span id="gear">1</span></h3>
        </div>

        <style>
            body {
                background: black;
                color: #cc5500;
            }
            small {
                font-size: 2vh;
            }
            h1 {
                font-size: 6vw;
            }
            #rpm {
                width: 12vh;
            }
            .valign {
                text-align: center;
            }
            .halign {
                margin: 0;
                position: absolute;
                top: 50%;
                left: 50%;
                margin-right: -50%;
                transform: translate(-50%, -50%)
            }
            
            .seg-bar-white {
                border: 1px solid white;
            }
            .seg-bar-white > .seg-fill {
                background: white;
            }

            .seg-bar-yellow {
                border: 1px solid yellow;
            }
            .seg-bar-yellow > .seg-fill {
                background: yellow;
            }

            .seg-bar-red {
                border: 1px solid red;
            }
            .seg-bar-red > .seg-fill {
                background: red;
            }

            .seg-bar {
                height:6vh;
                position:relative;
                width: 100%;
                color: white;
                font-size: 4.5vh;
                -webkit-text-stroke-width: 1px;
                -webkit-text-stroke-color: black;
            }
            .seg-fill {
                content:'\A';
                position:absolute;
                top:0; bottom:0;
                left:0; 
                width: 0%;
                z-index: -9999;
            }

            .blinking{
                animation:blinker .5s step-start infinite;
            }

            @keyframes blinker {
                50% {
                    opacity: .5;
                }
            }

        </style>
        <script type="text/javascript">
            var ranges;

            function update(data) {
                Object.keys(data).forEach(key => {
                    var field = document.getElementById(key);
                    if(field !== null) {
                        field.innerHTML = data[key];
                    }

                    var bar = document.getElementById(key + "-bar");
                    if(bar !== null && bar.children.length > 0) { // TODO: just look for .seg-fill
                        bar.children[bar.children.length - 1].style.width = (data[key] / ranges[key].max) * 100 + "%";
                        if(ranges[key] !== null) {
                            var this_range = ranges[key];
                            if(data[key] >= this_range["danger"]) {
                                if(bar.className.indexOf("seg-bar-red") == -1) {
                                    bar.className = bar.className.replace(" seg-bar-yellow", "");
                                    bar.className += " seg-bar-red blinking";
                                }
                            } else if(data[key] >= this_range["warning"]) {
                                if(bar.className.indexOf("seg-bar-yellow") == -1) {
                                    bar.className = bar.className.replace(" seg-bar-red blinking", "");
                                    bar.className += " seg-bar-yellow";
                                }
                            } else {
                                bar.className = bar.className.replace(" seg-bar-red blinking", "").replace(" seg-bar-yellow", "");
                            }
                        }
                    }
                });
            };

            function user_configuration(config) {
                ranges = config.ranges;
                Object.keys(config.units).forEach(key => {
                    var field = document.getElementById("units-" + key);
                    if(field !== null) {
                        field.innerHTML = config.units[key];
                    }
                });
            };

            var fullscreen = true;
            function switchFullScreen() {
                if(fullscreen) {
                    external.invoke('exit');
                } else {
                    external.invoke('enter');
                }
                fullscreen = !fullscreen;
            }
        </script>
    </body>
</html>